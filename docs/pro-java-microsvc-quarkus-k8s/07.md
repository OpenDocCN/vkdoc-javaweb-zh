# 7.微服务架构模式

## 介绍

到目前为止，我们已经将 QuarkuShop 开发为一个单块应用程序。所有组件都封装在一个封装中。这个单块被称为*整块*。

根据《牛津英语词典》，monolith 是指*“*一个单一的、非常大的组织，变化非常缓慢”。在软件架构世界中，monolithic 或 monolithic 应用程序是一个单块应用程序，其中所有组件都被组合到一个包中。

例如，在 QuarkuShop 项目中，如果开发人员想要更新一个`Product`实体的定义，他们将访问与另一个开发`PaymentService`的开发人员相同的代码库。在这些更新之后，他们必须重新构建并重新部署应用程序的更新版本。

在运行时，QuarkuShop 被部署为一个包，即我们使用 CI/CD 管道打包在 Docker 容器中的原生 JAR。所有的 Java 代码和 HTML/CSS 资源(我们在`src/main/resources/META-INF/resources`中有一个网页)将在同一个块中运行，即使我们在 JAR 中嵌入了一些 React 或 Angular 代码。

QuarkuShop 处理 HTTP 请求，执行一些特定于域的逻辑，从数据库中检索和更新数据，并处理要发送给 REST 客户机的有效负载。

由于所有这些原因，QuarkuShop 是一个庞然大物。![img/509649_1_En_7_Figa_HTML.gif](img/509649_1_En_7_Figa_HTML.gif)

这是好事还是坏事？ ![img/509649_1_En_7_Figb_HTML.gif](img/509649_1_En_7_Figb_HTML.gif)

在培训和讨论期间，当我说一个应用程序是一个整体时，许多人认为这是一件坏事。本章描述了这种架构的优缺点，我将让您决定它是好还是坏，或者好+坏(两者都有一点)。![img/509649_1_En_7_Figc_HTML.gif](img/509649_1_En_7_Figc_HTML.gif)

单片应用的主要好处是它的简单性。只开发、部署和扩展一个模块很容易。

因为整个应用程序的代码库都在一个地方，所以只需要配置一个插槽来构建和部署应用程序。

Monoliths 非常容易工作，尤其是在开始的时候，这是开始一个新项目的默认选择。虽然复杂性会随着时间的推移而增长，但代码库的敏捷管理将有助于在整体应用程序的整个生命周期中保持生产力。密切关注代码是如何编写的，以及架构是如何发展的，将会保护项目不会变成一大盘意大利面条。

虽然我告诉你敏捷将保证项目保持干净和容易进行，但是没有互惠。单片应用程序组件是非常紧密耦合的，随着产品的发展会变得非常复杂。因此，随着时间的推移，开发人员很难管理它们。

> “构建一个有效的复杂系统的方法是从非常简单的有效系统中构建它。”
> 
> —凯文·凯利

在现实世界的项目中，无论是中型还是大型项目，开发人员通常只处理应用程序的特定部分。每个开发人员通常只理解一个整体的一部分，这意味着很少有开发人员能够解释整个应用程序。由于 monoliths 必须作为一个单元来开发和部署，因此很难将开发工作分成独立的团队。每次代码更改都必须仔细协调，这会减慢开发速度。

这种情况对新开发人员来说可能很困难，他们不想处理多年来发展的大量代码库。结果，更多的时间花在寻找正确的代码行，并确保它没有副作用。同样，花在编写新特性上的时间会更少，而这些新特性将会改善应用程序。

在一个整体中采用新技术可能意味着重写整个应用程序，这是一项既费钱又费时的苦差事。

独石很受欢迎，因为它们比它们的替代品*微服务*更容易开始建造。

## 微服务架构

虽然 monolith 是一个单一的大型单元，但微服务架构使用小型的模块化代码单元，可以独立于产品的其余组件进行部署。

> “简单的可比复杂的难。你必须努力让你的思维变得干净，让它变得简单。”
> 
> —乔布斯

### 微服务架构的优势

微服务架构允许将一个大的应用程序分解成小的、松散耦合的服务。这种方法带来了很多好处:

*   我们的 QuarkuShop 应用程序是使用单片架构开发的，随着时间的推移，它已经增加了许多新特性。代码库是巨大的，新人正在加入我们的团队。他们很难开始使用给定的应用程序，因为应用程序的各个组件之间没有明确的界限。微服务方法允许我们将我们的应用程序视为小型、松散耦合的组件，因此任何人都可以在短时间内开始使用现有的应用程序。给代码库添加一个新的补丁不会太难。

*   想象一下，今天是黑色星期五，这是一年中最繁忙的购物日，所以我们的网站流量很大。我们的产品目录被高度要求，这导致整个应用程序下降。如果这发生在微服务架构中，我们不会面临这样的故障，因为它独立运行多个服务。如果一个服务关闭，不会影响任何其他服务。

*   我们是开发人员，花了很多时间来理解我们的应用程序代码库。我们对增加新功能感到兴奋，如产品搜索引擎。我们必须重新部署整个应用程序，以便向最终用户展示这些功能。我们将致力于许多这样的功能，想想每次部署所花费的时间。因此，如果应用程序很大，它需要大量的精力和时间，这肯定会导致生产力的损失。没有人喜欢等着看代码修改的结果。在微服务架构中，我们尽量使每个服务的代码库尽可能小，这样就不会在构建、部署等方面花费太多时间。

*   今天我们的流量很大。什么都没坏，服务器也启动了。假设我们需要扩展应用程序的某些组件，例如产品目录。我们不能在一个整体架构中扩展单个组件。但是，在微服务架构中，我们可以通过动态添加更多节点来单独扩展任何组件。

*   明天，我们希望迁移到新的框架或技术堆栈。很难升级一个整体，因为随着时间的推移，它已经变得非常大和复杂。更新微服务架构并不困难，因为组件小且灵活。

这就是微服务架构如何让我们的生活变得轻松。有各种各样的策略可以帮助我们将应用程序划分成小的服务，比如通过领域驱动的设计，通过业务能力，等等。

### 什么是真正的微服务？

一个*微服务*通常实现一组不同的特性或功能，比如订单管理、客户管理等。每个微服务都是一个迷你应用程序，有自己的业务逻辑和边界，比如 REST web 服务。一些微服务公开一个 API，由其他微服务或应用程序的客户端使用。其他微服务可能会实现 web UI。我们还可以使用消息队列进行通信。

应用程序的每个功能区域现在都由自己的微服务来实现。此外，web 应用程序被分成一组更小的 web 应用程序。

每个后端服务通常公开一个 REST API，大多数服务使用其他服务提供的 API。UI 服务调用其他服务来呈现网页。服务也可能使用异步的基于消息的通信。

一些 REST APIs 也暴露给不能直接访问后端服务的客户端应用程序。相反，通信是通过一个称为 *API 网关的中介进行的。*API 网关负责负载平衡、缓存、访问控制、API 计量和监控等任务。

微服务架构模式极大地影响了应用程序和数据库之间的关系。每个服务都有自己的数据库模式，而不是与其他服务共享一个数据库模式。一方面，这种方法与企业范围的数据模型的想法不一致。此外，它通常会导致一些数据的重复。然而，如果您想从微服务中获益，每个服务拥有一个数据库模式是必不可少的，因为它确保了松耦合。

每个服务都有一个数据库。此外，服务可以使用最适合其需求的数据库类型，即所谓的*多语言持久性架构*。

从表面上看，微服务架构模式类似于 SOA。使用这两种方法，架构都由一组服务组成。然而，考虑微服务架构模式的一种方式是，它是 SOA，没有商业化和 Web 服务规范(WS)和企业服务总线(ESB)的包袱。基于微服务的应用更喜欢 REST 等更简单、轻量级的协议，而不是繁重的协议。他们也非常避免使用 ESB，而是在微服务本身中实现类似 ESB 的功能。

## 结论:进行转换

那么，有没有可能不从零开始，从单片切换到微服务架构呢？值得吗？像网飞、亚马逊和推特这样的大公司都已经从整体架构转向微服务架构，并且没有回头的意思。

改变架构可以分阶段进行。您可以从整体应用程序中一个接一个地提取微服务，直到完成。一个好的架构选择可以让你的应用和组织变得更好。如果你正在考虑转换，你会在接下来的章节中得到一个很好的迁移指南。